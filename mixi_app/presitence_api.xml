<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs
   title="PresistenceAPI Test"
   description="This apply is Test for PresistenceAPI."
   auhtor="saronpasu"
   author_email="jamenco@gmail.com">
    <Require feature="opensocial-0.8" />
  </ModulePrefs>
  <Content type="html" view="canvas,profile,home"><![CDATA[
    <script type="text/javascript" lang="javascript">
      function main() {
        var result = "";
        var element = document.getElementById("main");
        var req = opensocial.newDataRequest();
        var inputName = "Tanaka";
        var inputAge = "28";
        var updateName = "Suzuki";
        var updateAge = "35";
        var fetchKeys = ["name", "age"];
        var removeKeys = ["name", "age"];
        var idSpecParam = {};
        idSpecParam[opensocial.IdSpec.Field.USER_ID] = opensocial.IdSpec.PersonId.VIEWER;
        var idSpec = opensocial.newIdSpec(idSpecParam);
        req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER), "viewer_response");
        var idspec = opensocial.newIdSpec(idSpecParam);
        req.add(req.newUpdatePersonAppDataRequest(opensocial.IdSpec.PersonId.VIEWER, "name", inputName), "create_response1");
        req.add(req.newUpdatePersonAppDataRequest(opensocial.IdSpec.PersonId.VIEWER, "age", inputAge), "create_response2");
        req.add(req.newFetchPersonAppDataRequest(idSpec, fetchKeys, "stored"), "fetch_response");
        req.add(req.newUpdatePersonAppDataRequest(opensocial.IdSpec.PersonId.VIEWER, "name", updateName), "update_response1");
        req.add(req.newUpdatePersonAppDataRequest(opensocial.IdSpec.PersonId.VIEWER, "age", updateAge), "update_response2");
        req.add(req.newRemovePersonAppDataRequest(opensocial.IdSpec.PersonId.VIEWER, removeKeys), "remove_response");
        req.send(function(response) {
          if(response.hadError()) {
            console.log("all request had error");
            // console.log("  error code: "+response.getErrorCode());
            console.log("  error message: "+response.getErrorMessage());
          } else {
            var fetchViewerResponse = response.get("viewer_response");
            var createResponse1 = response.get("create_response1");
            var createResponse2 = response.get("create_response2");
            var fetchResponse = response.get("fetch_response");
            var updateResponse1 = response.get("update_response1");
            var updateResponse2 = response.get("update_response2");
            var removeResponse = response.get("remove_response");
            if(fetchViewerResponse.hadError()) {
              console.log("fetch viewer response had error");
              console.log("  error code: "+fetchViewerResponse.getErrorCode());
              console.log("  error message: "+fetchViewerResponse.getErrorMessage());
            } else {
               var viewer = fetchViewerResponse.getData();
               result += "fetch viewer request: success.<br />";
            }
            if(createResponse1.hadError()) {
              console.log("create response1 had error");
              console.log("  error code: "+createResponse1.getErrorCode());
              console.log("  error message: "+createResponse1.getErrorMesasge());
            } else {
              result += "create request1: success.<br />";
            }
            if(createResponse2.hadError()) {
              console.log("create response2 had error");
              console.log("  error code: "+createResponse2.getErrorCode());
              console.log("  error message: "+createResponse2.getErrorMesasge());
            } else {
              result += "create request2: success.<br />";
            }
            if(fetchResponse.hadError()) {
              console.log("fetch response had error");
              console.log("  error code: "+fetchRequest.getErrorCode());
              console.log("  error message: "+fetchRequest.getErrorMesasge());
            } else {
              var stored = fetchResponse.getData();
              var obj = stored[viewer.getId()];
              var name = obj["name"];
              var age = obj["age"];
              result += "fetch request: success.<br />";
              result += "  name value: "+name+"<br />";
              result += "  age value: "+age+"<br />";
            }
            if(updateResponse1.hadError()) {
              console.log("update response had error");
              console.log("  error code: "+updateResponse1.getErrorCode());
              console.log("  error message: "+updateResponse1.getErrorMesasge());
            } else {
              result += "update request1: success.<br />";
            }
            if(updateResponse2.hadError()) {
              console.log("update respone2 had error");
              console.log("  error code: "+updateResponse2.getErrorCode());
              console.log("  error message: "+updateResponse2.getErrorMesasge());
            } else {
              result += "update request2: success.<br />";
            }
            if(removeResponse.hadError()) {
              console.log("remove response had error");
              console.log("  error code: "+removeResponse.getErrorCode());
              console.log("  error message: "+removeResponse.getErrorMesasge());
            } else {
              result += "remove request: success.<br />";
            }
            element.innerHTML = result;
          }
        });
      }

      gadgets.util.registerOnLoadHandler(main);
    </script>
    <div id="main"> </div>
  ]]></Content>
</Module>