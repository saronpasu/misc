<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs
   title="CheckOwnerViewer"
   description="This apply is Owner/Viewer Checker."
   auhtor="saronpasu"
   author_email="jamenco@gmail.com">
    <Require feature="opensocial-0.8" />
  </ModulePrefs>
  <Content type="html" view="canvas,profile,home"><![CDATA[
    <script type="text/javascript" lang="javascript">
      function viewerIsOwner() {
        var req = opensocial.newDataRequest();
        req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER), "viewer");
        req.send(function(response) {
          if (response.hadError()) {
            // error case
            console.log(response.getErrorMessage());
          } else {
            var viewer = response.get("viewer").getData();
			return viewer.isOwner();
          }
        });
      }

      function viewerHasApp() {
        var req = opensocial.newDataRequest();
		var opts = {};
		opts = [opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS] = [opensocial.Person.Field.HAS_APP];
		req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER), "viewer");
        req.send(function(response) {
          if (response.hadError()) {
            // error case
            console.log(response.getErrorMessage());
          } else {
			var viewer = response.get("viewer").getData();
			return viewer.getField(opensocial.Person.Field.HAS_APP);
          }
        });
      }

      function main() {
        var element = document.getElementById("main");
        if(viewerIsOwner()) {
          element.innerHTML = "Hi, AppliOwner!";
        } else {
          if(viewerHasApp()) {
            element.innerHTML = "Hi, Viewer(has apply)!";
          } else {
            element.innerHTML = "Hi, Viewer!";
          }
        }
      }

      gadgets.util.registerOnLoadHandler(main);
    </script>
    <div id="main">Error!</div>
  ]]></Content>
</Module>